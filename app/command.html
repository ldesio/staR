<html>
	<head>
		<link href="resources/bootstrap-3.3.5/css/united.min.css" rel="stylesheet" />
		<script src="resources/jquery-1.11.3/jquery.min.js"></script>
		<script>
			
			var sid = 0;
			var historyIndex = 0;

			function status(status) {
				//alert(status);
				document.getElementById('status').innerHTML = status;
			}
			function handleEnter(e){
				var keycode = (e.keyCode ? e.keyCode : e.which);
				if (keycode == '13') {
					runCommand();
				}
				// up
				if (keycode == '38') {
					if (historyIndex >= 0) {
						historyIndex -= 1;
						document.getElementById('command').value = getHistoryEntry(historyIndex);
						strLength = String(document.getElementById('command').value).length;
						//document.getElementById('command').setSelectionRange(strLength, strLength);
					} else {
						document.getElementById('command').value = "";
					}

				}
				// down
				if (keycode == '40') {
					var tableRef = window.parent.frames.hist.document.getElementById('hist_table').getElementsByTagName('tbody')[0];
					if (historyIndex < tableRef.rows.length) {
						historyIndex += 1;
						document.getElementById('command').value = getHistoryEntry(historyIndex);
						strLength = String(document.getElementById('command').value).length;
						//document.getElementById('command').setSelectionRange(strLength, strLength);
					} else {
						document.getElementById('command').value = "";
					}
				}
			}
			function scroll() {
					$('html, body',window.parent.frames.output.document).animate({
						scrollTop: $("#" + sid + "",window.parent.frames.output.document).offset().top
					}, 2000);
			}
			function addHistoryRow(cmd) {
				var tableRef = window.parent.frames.hist.document.getElementById('hist_table').getElementsByTagName('tbody')[0];

				var newRow   = tableRef.insertRow(tableRef.rows.length);

				var newCell  = newRow.insertCell();
				var newText  = window.parent.frames.output.document.createTextNode('' + tableRef.rows.length);
				newCell.appendChild(newText);

				var newCell  = newRow.insertCell();
				var newText  = window.parent.frames.output.document.createTextNode('' + cmd);
				newCell.appendChild(newText);

				window.parent.frames.hist.scrollTo(0,window.parent.frames.hist.document.body.scrollHeight);

				historyIndex = tableRef.rows.length; 

			}
			function getHistoryEntry(index) {
				var tableRef = window.parent.frames.hist.document.getElementById('hist_table').getElementsByTagName('tbody')[0];
				return tableRef.rows[index].cells[1].innerHTML;
			}

			function updateVars() {

				var doc = window.parent.frames.vars.document;

				$(doc).ready(function() {

					var tableRef = doc.getElementById('var_table').getElementsByTagName('tbody')[0];

					$(".varrow", doc).remove();

					$.getJSON( "/vartable", function( data ) {
					  var items = [];
					  $.each( data, function( key, val ) {
						
						var res = (val+'').split(" ");
						
						var newRow   = tableRef.insertRow(tableRef.rows.length);
						newRow.className = "varrow";

						var newCell  = newRow.insertCell();
						var newText  = doc.createTextNode('' + val[0]);
						newCell.appendChild(newText);

						var newCell  = newRow.insertCell();
						newCell.setAttribute("nowrap","nowrap");
						var newText  =doc.createTextNode('' + val[1]);
						newCell.appendChild(newText);

					  });

					});

				});

			}

	
			function runCommand() {
			
				
				start = new Date().getTime();

				status("Processing...");
				
				origCmd = document.getElementById('command').value;
				var patt = / +/g
				
				cmd = encodeURIComponent(origCmd.replace(patt, " "));

				
				
				$.get("/command?command=" + cmd, function( response ) {
					//$(window.parent.frames.output.document.body).append("<a id='" + sid + "'></a>");
					
					
					// trick to force image reload
					resp = (response+"").replace('.png"', '.png?' + new Date().getTime() + '"')
					
					
					
					$(window.parent.frames.output.document.body).append(resp);
					//$(window.parent.frames.output.document.body).append("<s" + "cript>location.href='#" + sid + "';</s" + "cript>");
					
					
					
					now = new Date().getTime();
					//status('Done (' + (now - start) + ' ms),');
					status("Done.")
					window.parent.frames.output.scrollTo(0,window.parent.frames.output.document.body.scrollHeight);

					document.getElementById('command').value = "";
					
					addHistoryRow(origCmd);
					
					if (origCmd.trim().substr(0,3)=="use")
					{
						updateVars();
					}
					
				}, 'html');

				
				
			}
		</script>
	</head>
	<body onkeydown="handleEnter(event)" style="background-color:#ececec">
		
		<table cellpadding="5" class="display" width="100%">
				<tr>
					<th style="background-color:#912400;font-size:12pt;text-align:left;color:white">Command</th>
				</tr>
		<tr>
		<td>
		<!--<form name="form">--> <!-- action="#" -->
            <input size="50" type="text" id="command" autocomplete="off"
				style="color:black;background-color:white;font-size:14pt;width:100%;height:50;text-align:top">
        <!--</form>-->
		</td>
		</tr>
		<tr><td><span id="status"></span></td></tr>
		</table>
	</body>
</html>



